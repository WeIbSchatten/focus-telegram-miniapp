services:
  focus-db:
    image: postgres:16
    container_name: focus-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-focus}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-focus_password}
      POSTGRES_DB: ${POSTGRES_DB:-focus_db}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - focus-db-data:/var/lib/postgresql/data
      - ./database/init-scripts:/docker-entrypoint-initdb.d

  focus-service:
    build: ./backend/focus-service
    container_name: focus-service
    depends_on:
      - focus-db
    env_file:
      - ./backend/focus-service/.env
    environment:
      - INTERNAL_API_SECRET=${INTERNAL_API_SECRET:-change_me_internal_secret}
    ports:
      - "3001:3000"

  focus-kids-service:
    build: ./backend/focus-kids-service
    container_name: focus-kids-service
    depends_on:
      - focus-db
      - focus-service
      - telegram-bot
    env_file:
      - ./backend/focus-kids-service/.env
    environment:
      - FOCUS_SERVICE_URL=http://focus-service:3000
      - TELEGRAM_BOT_NOTIFY_URL=http://focus-telegram-bot:4000
      - TELEGRAM_BOT_NOTIFY_SECRET=${TELEGRAM_BOT_NOTIFY_SECRET:-change_me_notify_secret}
      - CORS_ORIGINS_EXTRA=${CORS_ORIGINS_EXTRA:-https://09e52bf30fd6d5.lhr.life}
    ports:
      - "8001:8000"

  focus-sense-service:
    build: ./backend/focus-sense-service
    container_name: focus-sense-service
    depends_on:
      - focus-db
      - focus-service
    env_file:
      - ./backend/focus-sense-service/.env
    environment:
      - FOCUS_SERVICE_URL=http://focus-service:3000
      - CORS_ORIGINS_EXTRA=${CORS_ORIGINS_EXTRA:-https://09e52bf30fd6d5.lhr.life}
    ports:
      - "8002:8000"
    volumes:
      - sense-uploads:/app/uploads

  frontend:
    build:
      context: ./frontend
      args:
        NEXT_PUBLIC_FOCUS_API_URL: ""
        NEXT_PUBLIC_KIDS_API_URL: ""
        NEXT_PUBLIC_SENSE_API_URL: ""
        REWRITE_FOCUS_URL: http://focus-service:3000
        REWRITE_KIDS_URL: http://focus-kids-service:8000
        REWRITE_SENSE_URL: http://focus-sense-service:8000
    container_name: focus-frontend
    env_file:
      - ./frontend/.env.local
    environment:
      # Прокси: Next.js читает rewrites() при старте — без этого в контейнере fallback localhost и данные не грузятся
      - REWRITE_FOCUS_URL=http://focus-service:3000
      - REWRITE_KIDS_URL=http://focus-kids-service:8000
      - REWRITE_SENSE_URL=http://focus-sense-service:8000
    ports:
      - "3000:3000"
    depends_on:
      - focus-service
      - focus-kids-service
      - focus-sense-service

  telegram-bot:
    build: ./backend/telegram-bot
    container_name: focus-telegram-bot
    env_file:
      - ./backend/telegram-bot/.env
    environment:
      - FOCUS_SERVICE_URL=http://focus-service:3000
      - INTERNAL_API_SECRET=${INTERNAL_API_SECRET:-change_me_internal_secret}
      - NOTIFY_SECRET=${TELEGRAM_BOT_NOTIFY_SECRET:-change_me_notify_secret}
    depends_on:
      - focus-service
    ports:
      - "4000:4000"
    restart: unless-stopped

volumes:
  focus-db-data:
  sense-uploads:

